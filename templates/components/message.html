<div class="message" id="msg-{{ message.ts }}">
    <div class="message-avatar">
        {% if message.avatar_local %}
            <img src="{{ url_for('media', filepath=message.avatar_local) }}" alt="{{ message.display_name or message.user_name or 'User' }}" class="avatar-img">
        {% else %}
            <div class="avatar-placeholder">{{ (message.display_name or message.user_name or 'U')[0] | upper }}</div>
        {% endif %}
    </div>
    <div class="message-content">
        <div class="message-header">
            <span class="message-author">{{ message.display_name or message.user_name or 'Unknown' }}</span>
            <a class="message-time" href="/channel/{{ channel_name }}/around/{{ message.ts }}" title="{{ message.formatted_timestamp }}">{{ message.formatted_time }}</a>
        </div>
        <div class="message-text">{{ message.formatted_text | safe }}</div>

        {% if message.files %}
        <div class="message-files">
            {% for file in message.files %}
                {% if file.local_path and file.mimetype and file.mimetype.startswith('image/') %}
                    <div class="file-preview">
                        <img src="{{ url_for('media', filepath=file.local_path) }}" alt="{{ file.name }}" class="file-image">
                    </div>
                {% elif file.local_path %}
                    <div class="file-attachment">
                        <div class="file-icon">ðŸ“Ž</div>
                        <div class="file-info">
                            <a href="{{ url_for('media', filepath=file.local_path) }}" class="file-name" download>{{ file.name }}</a>
                            <span class="file-type">{{ file.mimetype or 'File' }}</span>
                        </div>
                    </div>
                {% else %}
                    <div class="file-attachment unavailable">
                        <div class="file-icon">ðŸ“Ž</div>
                        <div class="file-info">
                            <span class="file-name">{{ file.name }}</span>
                            <span class="file-type">File unavailable</span>
                        </div>
                    </div>
                {% endif %}
            {% endfor %}
        </div>
        {% endif %}

        {% if message.reactions %}
        <div class="message-reactions">
            {% for reaction in message.reactions %}
                <span class="reaction" title=":{{ reaction.name }}:">
                    <span class="reaction-emoji">
                        {% if reaction.emoji_info.type == 'custom' %}
                            <img src="{{ url_for('media', filepath=reaction.emoji_info.local_path) }}" alt=":{{ reaction.name }}:" class="custom-emoji">
                        {% else %}
                            {{ reaction.emoji_info.emoji }}
                        {% endif %}
                    </span>
                    <span class="reaction-count">{{ reaction.count }}</span>
                </span>
            {% endfor %}
        </div>
        {% endif %}

        {% if message.reply_count and message.reply_count > 0 %}
        <div class="message-thread">
            <a href="#" class="thread-trigger" data-thread-ts="{{ message.ts }}">
                <span class="thread-count">{{ message.reply_count }} {{ 'reply' if message.reply_count == 1 else 'replies' }}</span>
                <span class="thread-arrow">â†’</span>
            </a>
        </div>
        {% endif %}
    </div>
</div>
